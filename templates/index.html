<!DOCTYPE html>
<html>
	<head>
		<title></title>
		<style>
			body { margin: 0; }
		</style>
	</head>
	<body>
		<canvas id="canvas"></canvas>

        <script src="https://threejs.org/build/three.min.js"></script>
		<script src="https://threejs.org/examples/js/controls/OrbitControls.js"></script>

		<script>
			// Get Data From Server
			var mocap_frame_rate = {{frame_rate}};
			var frames = {{frames}};

			var width = window.innerWidth * 0.8;
			var height = window.innerHeight;

			// 캔버스 정의
			var canvas = document.getElementById("canvas");

			// 캔버스 크기 설정
			canvas.style.width = width;
			canvas.style.height = height;

			var renderer = new THREE.WebGLRenderer({
				canvas
			});

			renderer.setSize( width, height );
			document.body.appendChild(renderer.domElement);

			// 카메라 ( 카메라 수직 시야 각도, 가로세로 종횡비율, 시야거리 시작지점, 시야거리 끝지점
			var camera = new THREE.PerspectiveCamera( 45, width/height, 0.1, 10 );
			
			// 카메라 위치 설정
			camera.position.z = 2;

			var scenes = [];

			// 모델링 함수: Scene 생성
			function makeScene(points) {
				// 3차원 Scene 생성
				var scene = new THREE.Scene();

				// 빛을 생성
				var light1 = new THREE.DirectionalLight(0xffffff, 1);
				light1.position.set( 2, 2, 2 );
				scene.add( light1 );

				// 빛을 생성
				var light2 = new THREE.DirectionalLight(0xffffff, 1);
				light2.position.set( -2, -2, -2 );
				scene.add( light2 );

				// Axis
				var axesHelper = new THREE.AxesHelper(0.1);
				axesHelper.position.y = -0.5;
				scene.add(axesHelper);

				// Grid Floor
				var floor = new THREE.GridHelper(2, 20);
				floor.position.y = -0.5;
				scene.add(floor);

				// Spheres
				// Sphere Geometry
				var geometry = new THREE.SphereGeometry(0.003, 32, 32);
				// Sphere Material
				var material = new THREE.MeshPhongMaterial({color: 0xFFE800});

				for(var i=0; i<points.length; i++) {
					var sphere = new THREE.Mesh(geometry, material);

					var x = points[i][0] / 4000;					// 좌표계 변환 -0.5 ~ 0.5
					var y = (points[i][2] / 4000 * 2 - 1) / 2;		// (원본 데이터 가로,세로,높이 4m 가정)
					var z = -points[i][1] / 4000;
					
					sphere.position.set(x, y, z);
					scene.add(sphere);
				}

				return scene;
			}
			
			// 카메라와 마우스 상호작용을 위해 OrbitControls를 설정
			var controls = new THREE.OrbitControls(camera, renderer.domElement);
            var n = 0;
			var display_frame_rate = 60;	// 모니터 주사율

			// 렌더링 함수: 애니메이션 구현
            function animate() {
                if(mocap_frame_rate < display_frame_rate) {
                    setTimeout(function() {
                        requestAnimationFrame(animate);
                        var points = frames[n];
                        var scene = makeScene(points);
                        
                        n += 1;
                        if(n >= frames.length) {	// 처음부터 재시작
                            n = 0;
                        }
                        controls.update();	// 카메라 컨트롤
                        renderer.render(scene, camera);
                    }, 1000 / mocap_frame_rate)
                }

                else {
                    requestAnimationFrame(animate);
                    var k = Math.round(
                        frames.length * display_frame_rate / mocap_frame_rate
                        );
                    var d = (frames.length - 1) / (k - 1);
                    var points = frames[parseInt(n)];
                    var scene = makeScene(points);

                    n += d;
                    if(n >= frames.length) {	// 처음부터 재시작
                        n = 0;
                    }

                    controls.update();	// 카메라 컨트롤
                    renderer.render(scene, camera);
                }
            }
            animate();
		</script>
	</body>
</html>